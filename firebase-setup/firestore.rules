rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }
    match /users/{uid} {
    	allow read,write: if request.auth.uid == uid;
    }
    match /organizations/{organization} {
    	allow read: if request.auth.uid != null;
      allow create: if 
                    request.auth.token.email in request.resource.data.members && 
                    request.auth.token.email in request.resource.data.admins && 
                    request.auth.token.email in request.resource.data.superadmins;
      allow update: if 
                    request.auth.token.email in request.resource.data.superadmins &&
                    request.auth.token.email in resource.data.superadmins;
    }
    match /invoices/{invoice} {
      allow read:    if request.auth.token.email in get(/databases/$(database)/documents/organizations/$(resource.data.to.id)).data.members ||
                        request.auth.token.email in get(/databases/$(database)/documents/organizations/$(resource.data.from.id)).data.members ;
      allow update:  if request.auth.token.email in get(/databases/$(database)/documents/organizations/$(resource.data.from.id)).data.admins;
      allow write:   if request.auth.token.email in get(/databases/$(database)/documents/organizations/$(request.resource.data.from.id)).data.admins;
    }
  }
}